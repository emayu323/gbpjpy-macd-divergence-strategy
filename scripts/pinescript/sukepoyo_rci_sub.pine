//@version=6
indicator("sukepoyo RCI sub", overlay=false)

// ===== 入力パラメータ =====
rci_short_period = input.int(9, "RCI 短期", minval=1)
rci_mid_period   = input.int(14, "RCI 中期", minval=1)
rci_long_period  = input.int(18, "RCI 長期", minval=1)

// トリガー
rci_trigger = input.int(60, "RCI トリガー", minval=0, maxval=100)

// ===== 配色定義（最適化：オブジェクト生成回数を削減） =====
// ベースカラー
color col_bull_main = color.rgb(255, 50, 50)
color col_bear_main = color.rgb(0, 180, 255)

// 透過色を事前に定義（計算負荷軽減）
color c_bull_st3 = color.new(col_bull_main, 40)
color c_bull_st2 = color.new(col_bull_main, 60)
color c_bull_st1 = color.new(col_bull_main, 90)

color c_bear_st3 = color.new(col_bear_main, 40)
color c_bear_st2 = color.new(col_bear_main, 60)
color c_bear_st1 = color.new(col_bear_main, 90)

// ライン色
color c_line_short = color.new(color.red, 0)
color c_line_mid   = color.new(color.green, 0)
color c_line_long  = color.new(color.blue, 0)
color c_line_zero  = color.new(color.gray, 50)
color c_line_trig  = color.new(color.yellow, 50)

// ===== RCI計算関数（最適化：配列を除去し直接参照へ） =====
// ロジックは厳密な順位計算（同順位の平均処理）を維持
rci(int len) =>
    float sumD2 = 0.0

    // 配列生成・コピーのオーバーヘッドを削除し、直接closeを参照
    for i = 0 to len - 1
        float currentPrice = close[i]
        float timeRank = i + 1.0

        int countGreater = 0
        int countEqual = 0

        for j = 0 to len - 1
            float p = close[j]
            if p > currentPrice
                countGreater += 1
            else if p == currentPrice
                countEqual += 1

        // 同順位（タイ）がある場合の平均順位計算
        float priceRank = (countGreater + 1) + (countEqual - 1) / 2.0
        float d = timeRank - priceRank
        sumD2 += d * d

    // RCI算出
    float rciValue = (1.0 - (6.0 * sumD2) / (len * (len * len - 1.0))) * 100.0
    rciValue

// ===== RCIの計算 =====
rci_short = rci(rci_short_period)
rci_mid   = rci(rci_mid_period)
rci_long  = rci(rci_long_period)

// ===== 1. 短期RCI 状態管理（保持型） =====
var bool s_bull_armed = false
var bool s_bear_armed = false

if rci_short <= -rci_trigger
    s_bull_armed := true
if rci_short > 0
    s_bull_armed := false

if rci_short >= rci_trigger
    s_bear_armed := true
if rci_short < 0
    s_bear_armed := false

// ===== 2. 中期・長期のリアルタイム判定 =====
bool m_bull_now = rci_mid <= -rci_trigger
bool l_bull_now = rci_long <= -rci_trigger
bool m_bear_now = rci_mid >= rci_trigger
bool l_bear_now = rci_long >= rci_trigger

// ===== 3. ステージ判定（保持型） =====
var bool bull_st3_active = false
var bool bull_st2_active = false
var bool bear_st3_active = false
var bool bear_st2_active = false

// --- Bull (買い) ---
if rci_short > 0
    bull_st3_active := false
    bull_st2_active := false

if s_bull_armed
    if m_bull_now and l_bull_now
        bull_st3_active := true
        bull_st2_active := false
    else if m_bull_now and not bull_st3_active
        bull_st2_active := true

// --- Bear (売り) ---
if rci_short < 0
    bear_st3_active := false
    bear_st2_active := false

if s_bear_armed
    if m_bear_now and l_bear_now
        bear_st3_active := true
        bear_st2_active := false
    else if m_bear_now and not bear_st3_active
        bear_st2_active := true

// ===== 第1段階 (リアルタイム) =====
bool bull_st1_now = rci_short <= -rci_trigger
bool bear_st1_now = rci_short >= rci_trigger

// ===== 背景色出力フラグ =====
bg_bull_3 = bull_st3_active
bg_bull_2 = bull_st2_active
bg_bull_1 = bull_st1_now and not bull_st2_active and not bull_st3_active

bg_bear_3 = bear_st3_active
bg_bear_2 = bear_st2_active
bg_bear_1 = bear_st1_now and not bear_st2_active and not bear_st3_active

// スタイルタブ設定用（定義済み変数を使用）
bgcolor(bg_bull_3 ? c_bull_st3 : na, title="買い 短期＋中期＋長期", offset=0)
bgcolor(bg_bull_2 ? c_bull_st2 : na, title="買い 短期＋中期", offset=0)
bgcolor(bg_bull_1 ? c_bull_st1 : na, title="買い 短期", offset=0)

bgcolor(bg_bear_3 ? c_bear_st3 : na, title="売り 短期＋中期＋長期", offset=0)
bgcolor(bg_bear_2 ? c_bear_st2 : na, title="売り 短期＋中期", offset=0)
bgcolor(bg_bear_1 ? c_bear_st1 : na, title="売り 短期", offset=0)

// ===== RCI プロット =====
plot(rci_short, "RCI 短期", color=c_line_short, linewidth=2)
plot(rci_mid,   "RCI 中期", color=c_line_mid,   linewidth=1)
plot(rci_long,  "RCI 長期", color=c_line_long,  linewidth=1)

// ===== 目安ライン =====
hline(0, "0ライン", color=c_line_zero)
hline(rci_trigger, "+トリガー", color=c_line_trig, linestyle=hline.style_dashed, linewidth=1)
hline(-rci_trigger, "-トリガー", color=c_line_trig, linestyle=hline.style_dashed, linewidth=1)

// ===== アラート =====
alertcondition(bull_st1_now and not bull_st1_now[1], "Bull Stage1", "買い 短期")
alertcondition(bull_st2_active and not bull_st2_active[1], "Bull Stage2", "買い 短期＋中期")
alertcondition(bull_st3_active and not bull_st3_active[1], "Bull Stage3", "買い 短期＋中期＋長期")

alertcondition(bear_st1_now and not bear_st1_now[1], "Bear Stage1", "売り 短期")
alertcondition(bear_st2_active and not bear_st2_active[1], "Bear Stage2", "売り 短期＋中期")
alertcondition(bear_st3_active and not bear_st3_active[1], "Bear Stage3", "売り 短期＋中期＋長期")
