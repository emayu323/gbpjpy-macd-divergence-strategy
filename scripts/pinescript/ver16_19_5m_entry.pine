//@version=5
indicator("Ver16-19 5M Entry Signal", overlay=true)

// ==========================================
// Ver16-19 5分足エントリー条件
// - RCI(9) ±70到達後の反転
// - パーフェクトオーダー (20>30>40 EMA)
// - ローソク足確定でシグナル
// ==========================================

// === 設定 ===
rci_length = input.int(9, "RCI期間", minval=1)
rci_threshold = input.int(70, "RCI閾値", minval=50, maxval=95)
ema_short = input.int(20, "EMA短期")
ema_mid = input.int(30, "EMA中期")
ema_long = input.int(40, "EMA長期")

// === RCI計算 ===
rci(src, length) =>
    sum_d2 = 0.0
    for i = 0 to length - 1
        price_rank = 0.0
        count_less = 0
        count_equal = 0
        current_price = src[i]
        for j = 0 to length - 1
            if src[j] < current_price
                count_less += 1
            else if src[j] == current_price
                count_equal += 1
        price_rank := 1 + count_less + (count_equal - 1) / 2.0
        time_rank = length - i
        d = price_rank - time_rank
        sum_d2 += d * d
    n = length
    rci_val = (1 - 6 * sum_d2 / (n * (n * n - 1))) * 100
    rci_val

// === インジケーター計算 ===
rci_value = rci(close, rci_length)
rci_prev1 = rci_value[1]
rci_prev2 = rci_value[2]

ema20 = ta.ema(close, ema_short)
ema30 = ta.ema(close, ema_mid)
ema40 = ta.ema(close, ema_long)

// === パーフェクトオーダー判定 ===
po_uptrend = ema20 > ema30 and ema30 > ema40
po_downtrend = ema20 < ema30 and ema30 < ema40

// === エントリー条件 ===
// 買い: RCIが-70以下に到達後、反転上昇 + 上昇PO
rci_reached_oversold = rci_prev1 <= -rci_threshold or rci_prev2 <= -rci_threshold
rci_hook_up = rci_value > rci_prev1
long_signal = rci_reached_oversold and rci_hook_up and po_uptrend

// 売り: RCIが+70以上に到達後、反転下落 + 下降PO
rci_reached_overbought = rci_prev1 >= rci_threshold or rci_prev2 >= rci_threshold
rci_hook_down = rci_value < rci_prev1
short_signal = rci_reached_overbought and rci_hook_down and po_downtrend

// === 表示 ===
// EMAライン
plot(ema20, "EMA20", color=color.new(color.blue, 0), linewidth=1)
plot(ema30, "EMA30", color=color.new(color.orange, 0), linewidth=1)
plot(ema40, "EMA40", color=color.new(color.red, 0), linewidth=1)

// シグナル
plotshape(long_signal, "Long Signal", shape.triangleup, location.belowbar, color.green, size=size.small)
plotshape(short_signal, "Short Signal", shape.triangledown, location.abovebar, color.red, size=size.small)

// アラート
alertcondition(long_signal, "5M Long Entry", "Ver16-19: 5M買いシグナル")
alertcondition(short_signal, "5M Short Entry", "Ver16-19: 5M売りシグナル")

// === RCI表示用 (別ペイン) ===
// 別のインジケーターとして追加するか、以下をコメント解除
// plot(rci_value, "RCI", color=color.purple)
// hline(70, "上限", color=color.gray, linestyle=hline.style_dashed)
// hline(-70, "下限", color=color.gray, linestyle=hline.style_dashed)
