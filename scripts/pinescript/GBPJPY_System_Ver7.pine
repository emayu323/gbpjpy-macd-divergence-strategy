//@version=5
indicator("GBPJPY System Ver7 - MACD Divergence Strategy", overlay=true, max_lines_count=500, max_labels_count=500)

// ==========================================
// 設定パラメータ
// ==========================================

// RCI設定
rci_short_period = input.int(9, "RCI短期", minval=1)
rci_mid_period = input.int(14, "RCI中期", minval=1)
rci_oversold = input.int(-60, "RCI売られすぎ", maxval=0)
rci_overbought = input.int(60, "RCI買われすぎ", minval=0)
rci_mid_oversold = input.int(-40, "RCI中期売られすぎ", maxval=0)
rci_mid_overbought = input.int(40, "RCI中期買われすぎ", minval=0)

// EMA設定（4時間足トレンド判定）
ema_short = input.int(20, "EMA短期", minval=1)
ema_mid = input.int(30, "EMA中期", minval=1)
ema_long = input.int(40, "EMA長期", minval=1)

// MACD設定（1時間足ダイバージェンス）
macd_fast = input.int(12, "MACD Fast", minval=1)
macd_slow = input.int(26, "MACD Slow", minval=1)
macd_signal = input.int(9, "MACD Signal", minval=1)

// ZigZag設定
zigzag_depth_5m = input.int(5, "ZigZag 5分足 Depth", minval=1)
zigzag_depth_1h = input.int(12, "ZigZag 1時間足 Depth", minval=1)

// リスクリワード
risk_reward = input.float(1.5, "リスクリワード", minval=0.1, step=0.1)
sl_buffer_pips = input.float(2.0, "SLバッファ(pips)", minval=0, step=0.1)

// 表示設定
show_entries = input.bool(true, "エントリーシグナル表示")
show_sl_tp = input.bool(true, "SL/TP表示")
show_divergence = input.bool(true, "ダイバージェンス表示")
show_background = input.bool(true, "背景色表示（エントリー可能）")

// ==========================================
// RCI計算関数
// ==========================================
rci(src, length) =>
    var float rci_value = na
    if bar_index >= length - 1
        // 順位相関係数を計算
        sum_d2 = 0.0
        for i = 0 to length - 1
            price_at_i = src[length - 1 - i]
            // 価格順位を計算（高い方が上位）
            rank_price = 1.0
            for j = 0 to length - 1
                if src[length - 1 - j] > price_at_i
                    rank_price := rank_price + 1
                else if src[length - 1 - j] == price_at_i and j < i
                    rank_price := rank_price + 0.5

            // 時間順位（最新が1位）
            rank_time = float(i + 1)

            // 差の二乗
            d = rank_time - rank_price
            sum_d2 := sum_d2 + d * d

        // RCI計算
        rci_value := (1 - (6 * sum_d2) / (length * (length * length - 1))) * 100
    rci_value

// ==========================================
// 上位足データ取得
// ==========================================

// 4時間足のEMA
ema_20_4h = request.security(syminfo.tickerid, "240", ta.ema(close, ema_short))
ema_30_4h = request.security(syminfo.tickerid, "240", ta.ema(close, ema_mid))
ema_40_4h = request.security(syminfo.tickerid, "240", ta.ema(close, ema_long))

// 1時間足のMACD
[macd_line_1h, signal_line_1h, hist_1h] = request.security(syminfo.tickerid, "60", ta.macd(close, macd_fast, macd_slow, macd_signal))

// 1時間足の高値・安値
high_1h = request.security(syminfo.tickerid, "60", high)
low_1h = request.security(syminfo.tickerid, "60", low)
close_1h = request.security(syminfo.tickerid, "60", close)

// ==========================================
// 5分足インジケーター計算
// ==========================================

// RCI計算
rci_9 = rci(close, rci_short_period)
rci_14 = rci(close, rci_mid_period)

// ZigZag簡易実装（5分足）
var float zz_high = na
var float zz_low = na
var int last_pivot = 0  // 1: high, -1: low

// 直近の高値・安値を検出
is_pivot_high = ta.pivothigh(high, zigzag_depth_5m, zigzag_depth_5m)
is_pivot_low = ta.pivotlow(low, zigzag_depth_5m, zigzag_depth_5m)

if not na(is_pivot_high)
    zz_high := is_pivot_high
    last_pivot := 1

if not na(is_pivot_low)
    zz_low := is_pivot_low
    last_pivot := -1

// ==========================================
// 4時間足トレンド判定
// ==========================================

trend_4h = ema_20_4h > ema_30_4h and ema_30_4h > ema_40_4h ? 1 :
           ema_20_4h < ema_30_4h and ema_30_4h < ema_40_4h ? -1 : 0

trend_4h_uptrend = trend_4h == 1
trend_4h_downtrend = trend_4h == -1
trend_4h_none = trend_4h == 0

// ==========================================
// 1時間足ダイバージェンス検出（簡易版）
// ==========================================

// 注：完全なダイバージェンス検出は複雑なため、簡易版を実装
// 実際の検出は1時間足のZigZagポイントを使用する必要がある

// 1時間足の直近高値・安値
var float prev_high_1h = na
var float prev_low_1h = na
var float prev_macd_at_high = na
var float prev_macd_at_low = na

pivot_high_1h = ta.pivothigh(high_1h, zigzag_depth_1h, zigzag_depth_1h)
pivot_low_1h = ta.pivotlow(low_1h, zigzag_depth_1h, zigzag_depth_1h)

// ダイバージェンスフラグ
var bool divergence_long = false
var bool divergence_short = false
var int divergence_bar = 0

// 買いダイバージェンス検出
if not na(pivot_low_1h) and not na(prev_low_1h)
    current_macd = macd_line_1h[zigzag_depth_1h]

    // ヒドゥン・ダイバージェンス（上昇トレンド）：価格↑、MACD↓
    if pivot_low_1h > prev_low_1h and current_macd < prev_macd_at_low and trend_4h_uptrend
        divergence_long := true
        divergence_bar := bar_index

    // レギュラー・ダイバージェンス：価格↓、MACD↑
    if pivot_low_1h < prev_low_1h and current_macd > prev_macd_at_low
        divergence_long := true
        divergence_bar := bar_index

    prev_low_1h := pivot_low_1h
    prev_macd_at_low := current_macd

// 売りダイバージェンス検出
if not na(pivot_high_1h) and not na(prev_high_1h)
    current_macd = macd_line_1h[zigzag_depth_1h]

    // ヒドゥン・ダイバージェンス（下降トレンド）：価格↓、MACD↑
    if pivot_high_1h < prev_high_1h and current_macd > prev_macd_at_high and trend_4h_downtrend
        divergence_short := true
        divergence_bar := bar_index

    // レギュラー・ダイバージェンス：価格↑、MACD↓
    if pivot_high_1h > prev_high_1h and current_macd < prev_macd_at_high
        divergence_short := true
        divergence_bar := bar_index

    prev_high_1h := pivot_high_1h
    prev_macd_at_high := current_macd

// ダイバージェンス有効期間（12時間 = 144本の5分足）
divergence_valid_bars = 144
divergence_long_active = divergence_long and (bar_index - divergence_bar) <= divergence_valid_bars
divergence_short_active = divergence_short and (bar_index - divergence_bar) <= divergence_valid_bars

// 12時間経過したらリセット
if (bar_index - divergence_bar) > divergence_valid_bars
    divergence_long := false
    divergence_short := false

// ==========================================
// 5分足エントリー条件
// ==========================================

// 買いエントリー条件
entry_long_rci = rci_9 <= rci_oversold and rci_9 > rci_9[1]
entry_long_rci_mid = rci_14 <= rci_mid_oversold and rci_14 > rci_14[1]
entry_long_5m = entry_long_rci and entry_long_rci_mid

// 売りエントリー条件
entry_short_rci = rci_9 >= rci_overbought and rci_9 < rci_9[1]
entry_short_rci_mid = rci_14 >= rci_mid_overbought and rci_14 < rci_14[1]
entry_short_5m = entry_short_rci and entry_short_rci_mid

// 最終エントリーシグナル
signal_long = trend_4h_uptrend and divergence_long_active and entry_long_5m
signal_short = trend_4h_downtrend and divergence_short_active and entry_short_5m

// エントリー可能フラグ（背景色用）
setup_long = trend_4h_uptrend and divergence_long_active
setup_short = trend_4h_downtrend and divergence_short_active

// ==========================================
// SL/TP計算
// ==========================================

var float entry_price = na
var float stop_loss = na
var float take_profit = na
var bool in_position = false
var int position_direction = 0  // 1: long, -1: short

// エントリー処理
if signal_long and not in_position
    entry_price := close
    stop_loss := na(zz_low) ? close - sl_buffer_pips * 0.01 : zz_low - sl_buffer_pips * 0.01
    risk = entry_price - stop_loss
    take_profit := entry_price + risk * risk_reward
    in_position := true
    position_direction := 1

if signal_short and not in_position
    entry_price := close
    stop_loss := na(zz_high) ? close + sl_buffer_pips * 0.01 : zz_high + sl_buffer_pips * 0.01
    risk = stop_loss - entry_price
    take_profit := entry_price - risk * risk_reward
    in_position := true
    position_direction := -1

// エグジット判定
if in_position
    if position_direction == 1  // Long
        if high >= take_profit
            in_position := false
            position_direction := 0
        else if low <= stop_loss
            in_position := false
            position_direction := 0
    else if position_direction == -1  // Short
        if low <= take_profit
            in_position := false
            position_direction := 0
        else if high >= stop_loss
            in_position := false
            position_direction := 0

// ==========================================
// 視覚的表示
// ==========================================

// 背景色（エントリー可能状態）
bgcolor(show_background and setup_long ? color.new(color.green, 95) : na, title="買いセットアップ")
bgcolor(show_background and setup_short ? color.new(color.red, 95) : na, title="売りセットアップ")

// エントリーシグナル
plotshape(show_entries and signal_long, "買いシグナル", shape.triangleup, location.belowbar,
          color.new(color.green, 0), size=size.normal)
plotshape(show_entries and signal_short, "売りシグナル", shape.triangledown, location.abovebar,
          color.new(color.red, 0), size=size.normal)

// SL/TPライン
plot(show_sl_tp and in_position and position_direction == 1 ? stop_loss : na,
     "買いSL", color.red, 2, plot.style_linebr)
plot(show_sl_tp and in_position and position_direction == 1 ? take_profit : na,
     "買いTP", color.green, 2, plot.style_linebr)
plot(show_sl_tp and in_position and position_direction == -1 ? stop_loss : na,
     "売りSL", color.red, 2, plot.style_linebr)
plot(show_sl_tp and in_position and position_direction == -1 ? take_profit : na,
     "売りTP", color.green, 2, plot.style_linebr)

// エントリー価格ライン
plot(show_sl_tp and in_position ? entry_price : na,
     "エントリー価格", color.blue, 1, plot.style_linebr)

// ==========================================
// 情報パネル
// ==========================================

// トレンド状態
var table info_table = table.new(position.top_right, 2, 6, border_width=1)

if barstate.islast
    table.cell(info_table, 0, 0, "4H トレンド", text_color=color.white, bgcolor=color.gray)
    table.cell(info_table, 1, 0,
               trend_4h_uptrend ? "上昇" : trend_4h_downtrend ? "下降" : "なし",
               text_color=color.white,
               bgcolor=trend_4h_uptrend ? color.green : trend_4h_downtrend ? color.red : color.gray)

    table.cell(info_table, 0, 1, "ダイバージェンス", text_color=color.white, bgcolor=color.gray)
    table.cell(info_table, 1, 1,
               divergence_long_active ? "買い" : divergence_short_active ? "売り" : "なし",
               text_color=color.white,
               bgcolor=divergence_long_active ? color.green : divergence_short_active ? color.red : color.gray)

    table.cell(info_table, 0, 2, "RCI短期(9)", text_color=color.white, bgcolor=color.gray)
    table.cell(info_table, 1, 2, str.tostring(rci_9, "#.0"),
               text_color=color.white,
               bgcolor=rci_9 <= rci_oversold ? color.green : rci_9 >= rci_overbought ? color.red : color.gray)

    table.cell(info_table, 0, 3, "RCI中期(14)", text_color=color.white, bgcolor=color.gray)
    table.cell(info_table, 1, 3, str.tostring(rci_14, "#.0"),
               text_color=color.white,
               bgcolor=rci_14 <= rci_mid_oversold ? color.green : rci_14 >= rci_mid_overbought ? color.red : color.gray)

    table.cell(info_table, 0, 4, "セットアップ", text_color=color.white, bgcolor=color.gray)
    table.cell(info_table, 1, 4,
               setup_long ? "買い可能" : setup_short ? "売り可能" : "待機",
               text_color=color.white,
               bgcolor=setup_long ? color.new(color.green, 50) : setup_short ? color.new(color.red, 50) : color.gray)

    table.cell(info_table, 0, 5, "ポジション", text_color=color.white, bgcolor=color.gray)
    table.cell(info_table, 1, 5,
               in_position ? (position_direction == 1 ? "買い保有中" : "売り保有中") : "なし",
               text_color=color.white,
               bgcolor=in_position ? (position_direction == 1 ? color.blue : color.orange) : color.gray)

// ==========================================
// アラート
// ==========================================

alertcondition(signal_long, "買いシグナル", "GBPJPY Ver7: 買いエントリー")
alertcondition(signal_short, "売りシグナル", "GBPJPY Ver7: 売りエントリー")
alertcondition(setup_long, "買いセットアップ", "GBPJPY Ver7: 買いセットアップ完了")
alertcondition(setup_short, "売りセットアップ", "GBPJPY Ver7: 売りセットアップ完了")
